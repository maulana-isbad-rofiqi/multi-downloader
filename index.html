<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Downloader ‚Ä¢ Itsbad</title>
    <meta name="theme-color" content="#0f172a">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/7269/7269995.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #0f172a; color: white; }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gradient-text {
            background: linear-gradient(to right, #60a5fa, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .btn-process { animation: pulse-ring 2s infinite; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col relative overflow-x-hidden selection:bg-blue-500 selection:text-white">

    <nav class="glass fixed top-0 w-full z-50 px-6 py-4 flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg"><i class="fa-solid fa-bolt text-white"></i></div>
            <h1 class="text-xl font-bold tracking-wide">Multi<span class="text-blue-400">Loader</span></h1>
        </div>
        <button onclick="toggleModal('aboutModal')" class="text-sm font-semibold text-slate-300 hover:text-white transition">
            <i class="fa-solid fa-circle-info mr-1"></i> Info
        </button>
    </nav>

    <main class="container mx-auto mt-28 px-4 pb-20 max-w-3xl">
        
        <div class="text-center mb-8">
            <h2 class="text-3xl md:text-5xl font-bold mb-3 text-white">
                Download <span class="gradient-text">Everything.</span>
            </h2>
            <p class="text-slate-400 text-sm md:text-base">Paste link, Auto-detect, Download. Semudah itu.</p>
        </div>

        <div class="glass rounded-2xl p-2 md:p-3 mb-8 shadow-2xl shadow-blue-900/10 relative z-20">
            <div class="flex flex-col md:flex-row gap-2">
                <div class="relative w-full">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i id="inputIcon" class="fa-solid fa-link text-slate-500"></i>
                    </div>
                    <input type="text" id="urlInput" 
                        class="w-full bg-slate-800/50 border border-slate-600 rounded-xl pl-12 pr-4 py-4 focus:outline-none focus:border-blue-500 focus:bg-slate-800 transition text-white placeholder-slate-500" 
                        placeholder="Tempel link TikTok, YouTube, Spotify, dll..."
                        oninput="checkAutoDetect(this.value)">
                </div>
                <button onclick="processInput()" id="actionBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-xl font-bold transition flex items-center justify-center gap-2 whitespace-nowrap shadow-lg shadow-blue-600/30">
                    <i class="fa-solid fa-cloud-arrow-down"></i> <span id="btnText">Download</span>
                </button>
            </div>
            <div id="statusBadge" class="hidden mt-3 px-2 flex items-center gap-2 text-xs font-mono text-blue-400">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                </span>
                <span id="statusText">Mendeteksi link...</span>
            </div>
        </div>

        <div class="mb-4 flex justify-between items-end">
            <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Atau Pilih Manual (Cari Lagu)</h3>
        </div>

        <div class="grid grid-cols-4 md:grid-cols-6 gap-3 mb-10">
            <div id="serviceGrid" class="contents"></div>
        </div>

        <div id="resultSection" class="hidden glass rounded-2xl overflow-hidden animate-fade-in border-t-2 border-blue-500/50">
            <div id="resultContent" class="p-6"></div>
        </div>
        
        <div id="loader" class="hidden py-10 text-center">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-slate-700 border-t-blue-500 mb-4"></div>
            <p class="text-slate-400 text-sm animate-pulse" id="loadingText">Menghubungkan ke Server...</p>
        </div>

    </main>

    <div id="aboutModal" class="fixed inset-0 z-[100] hidden bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass bg-slate-900 p-8 rounded-3xl max-w-sm w-full text-center relative shadow-2xl border border-slate-700">
            <button onclick="toggleModal('aboutModal')" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800 rounded-full p-2 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <div class="w-20 h-20 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-2xl rotate-3 mx-auto mb-6 flex items-center justify-center text-3xl text-white font-bold shadow-lg shadow-blue-500/30">
                IB
            </div>
            <h3 class="text-2xl font-bold text-white mb-1">Multi Downloader</h3>
            <p class="text-blue-400 text-sm font-mono mb-6">Premium Tools</p>
            <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                <p class="text-xs text-slate-500 uppercase tracking-widest mb-1">Developed by</p>
                <p class="text-xl font-bold text-white tracking-wider">„ÄêÔªø ùïÄùï•ùï§ùïìùïíùïï „Äë</p>
            </div>
        </div>
    </div>

    <div id="pwaPopup" class="fixed bottom-0 left-0 right-0 glass border-t border-slate-700 p-4 transform translate-y-full transition-transform duration-500 z-50 flex items-center justify-between md:rounded-t-2xl md:max-w-md md:mx-auto md:bottom-4 md:rounded-b-2xl">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2.5 rounded-xl"><i class="fa-solid fa-download text-white"></i></div>
            <div>
                <h4 class="font-bold text-sm text-white">Install Aplikasi</h4>
                <p class="text-xs text-slate-400">Akses lebih cepat & ringan</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="closePwa()" class="text-slate-400 px-3 hover:text-white">Nanti</button>
            <button onclick="installPwa()" class="bg-white text-slate-900 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-50 transition">Install</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI API & FALLBACK SYSTEM ---
        const apiBase = "https://api.ootaizumi.web.id/downloader/";

        // Struktur: key = ID Platform. value = Array API (Urutan Prioritas)
        // Jika API[0] gagal, script akan mencoba API[1], dst.
        const platforms = {
            tiktok: {
                name: "TikTok",
                icon: "fa-brands fa-tiktok",
                match: ["tiktok.com"],
                apis: [
                    { end: "tiktok", param: "url" },
                    { end: "ssstiktok", param: "url" }, // Cadangan 1
                    { end: "snaptik", param: "url" }    // Cadangan 2
                ]
            },
            youtube: {
                name: "YouTube",
                icon: "fa-brands fa-youtube",
                match: ["youtube.com", "youtu.be"],
                apis: [
                    { end: "youtube", param: "url", extra: "&format=mp4" },
                    { end: "youtubev2", param: "url" }, // Cadangan 1
                    { end: "youtube-play", param: "query" } // Fallback terakhir (search mode)
                ]
            },
            spotify: {
                name: "Spotify",
                icon: "fa-brands fa-spotify",
                match: ["open.spotify.com"],
                apis: [
                    { end: "spotify-v2", param: "url" },
                    { end: "spotify", param: "url" } // Cadangan
                ]
            },
            instagram: {
                name: "Instagram",
                icon: "fa-brands fa-instagram",
                match: ["instagram.com"],
                apis: [ { end: "instagram", param: "url" } ]
            },
            facebook: {
                name: "Facebook",
                icon: "fa-brands fa-facebook",
                match: ["facebook.com", "fb.watch"],
                apis: [ { end: "facebook", param: "url" } ]
            },
            twitter: {
                name: "Twitter/X",
                icon: "fa-brands fa-x-twitter",
                match: ["twitter.com", "x.com"],
                apis: [ { end: "twitter", param: "url" } ]
            },
            soundcloud: {
                name: "SoundCloud",
                icon: "fa-brands fa-soundcloud",
                match: ["soundcloud.com"],
                apis: [ { end: "soundcloud", param: "url" } ]
            },
            scribd: {
                name: "Scribd",
                icon: "fa-solid fa-book-open",
                match: ["scribd.com"],
                apis: [ { end: "scribd", param: "url" } ]
            },
            sfile: {
                name: "Sfile.mobi",
                icon: "fa-solid fa-folder-open",
                match: ["sfile.mobi"],
                apis: [ { end: "sfile", param: "url" } ]
            },
            gdrive: {
                name: "Google Drive",
                icon: "fa-brands fa-google-drive",
                match: ["drive.google.com"],
                apis: [ { end: "gdrive", param: "url" } ]
            },
            mediafire: {
                name: "Mediafire",
                icon: "fa-solid fa-fire",
                match: ["mediafire.com"],
                apis: [ { end: "mediafire", param: "url" } ]
            },
            rednote: {
                name: "RedNote", // Xiaohongshu
                icon: "fa-solid fa-book-journal-whills",
                match: ["xiaohongshu.com"],
                apis: [ { end: "rednote", param: "url" } ]
            },
            // Fitur Pencarian (Manual Select Only)
            ytsearch: {
                name: "Cari Lagu YT",
                icon: "fa-solid fa-magnifying-glass",
                isSearch: true,
                apis: [ { end: "youtube-play", param: "query" } ]
            },
            spotsearch: {
                name: "Cari Lagu Spotify",
                icon: "fa-brands fa-spotify",
                isSearch: true,
                apis: [ { end: "spotifyplay", param: "query" } ]
            }
        };

        let currentMode = 'auto'; // 'auto' or specific platform key

        // --- RENDER ICON GRID ---
        const grid = document.getElementById('serviceGrid');
        Object.keys(platforms).forEach(key => {
            const p = platforms[key];
            const div = document.createElement('div');
            div.className = "glass p-3 rounded-xl flex flex-col items-center gap-2 cursor-pointer hover:bg-slate-700/50 transition active:scale-95";
            div.onclick = () => setManualMode(key);
            div.innerHTML = `
                <i class="${p.icon} text-2xl text-slate-300"></i>
                <span class="text-[10px] font-semibold text-slate-400 text-center leading-tight">${p.name}</span>
            `;
            grid.appendChild(div);
        });

        // --- AUTO DETECT LOGIC ---
        function checkAutoDetect(val) {
            const icon = document.getElementById('inputIcon');
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');

            if (!val) {
                currentMode = 'auto';
                icon.className = "fa-solid fa-link text-slate-500";
                statusBadge.classList.add('hidden');
                document.getElementById('btnText').innerText = "Download";
                return;
            }

            // Loop untuk cek kecocokan URL
            let detected = null;
            for (const [key, data] of Object.entries(platforms)) {
                if (data.match && data.match.some(domain => val.includes(domain))) {
                    detected = key;
                    break;
                }
            }

            if (detected) {
                currentMode = detected;
                const p = platforms[detected];
                icon.className = `${p.icon} text-blue-400`;
                statusBadge.classList.remove('hidden');
                statusText.innerText = `Terdeteksi: ${p.name}`;
                statusText.className = "text-blue-400";
            } else {
                currentMode = 'auto'; // Tetap auto, siapa tahu user mau search
                icon.className = "fa-solid fa-globe text-slate-500";
                statusBadge.classList.add('hidden');
            }
        }

        function setManualMode(key) {
            currentMode = key;
            const p = platforms[key];
            const input = document.getElementById('urlInput');
            
            // Visual Updates
            document.getElementById('inputIcon').className = `${p.icon} text-blue-400`;
            document.getElementById('statusBadge').classList.remove('hidden');
            document.getElementById('statusText').innerText = `Mode: ${p.name}`;
            
            if(p.isSearch) {
                input.placeholder = `Ketik judul lagu untuk ${p.name}...`;
                document.getElementById('btnText').innerText = "Cari";
            } else {
                input.placeholder = `Tempel link ${p.name} di sini...`;
                document.getElementById('btnText').innerText = "Download";
            }
            input.focus();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- PROSES DOWNLOAD (CORE LOGIC) ---
        async function processInput() {
            const input = document.getElementById('urlInput').value.trim();
            if (!input) return alert("Harap masukkan link atau kata kunci!");

            // Jika masih mode auto tapi tidak terdeteksi link (kemungkinan search)
            if (currentMode === 'auto') {
                if (!input.startsWith('http')) {
                    alert("Untuk pencarian lagu, silakan pilih ikon 'Cari Lagu' di bawah terlebih dahulu.");
                    return;
                }
                alert("Platform tidak dikenali otomatis. Silakan pilih ikon manual di bawah.");
                return;
            }

            const platformData = platforms[currentMode];
            const loader = document.getElementById('loader');
            const resultSection = document.getElementById('resultSection');
            const loadingText = document.getElementById('loadingText');

            resultSection.classList.add('hidden');
            loader.classList.remove('hidden');

            // --- LOOP API (FALLBACK SYSTEM) ---
            let success = false;
            for (let i = 0; i < platformData.apis.length; i++) {
                const api = platformData.apis[i];
                
                // Update text status loading
                loadingText.innerText = `Mencoba Server ${i + 1} (${platformData.name})...`;

                try {
                    // Construct URL
                    let fetchUrl = `${apiBase}${api.end}?${api.param}=${encodeURIComponent(input)}`;
                    if (api.extra) fetchUrl += api.extra;

                    const response = await fetch(fetchUrl);
                    const json = await response.json();

                    // Validasi sederhana jika JSON kosong atau error
                    if (json && (json.url || json.result || json.data)) {
                        renderResult(json);
                        success = true;
                        break; // Stop loop jika berhasil
                    } else {
                        throw new Error("Empty result");
                    }
                } catch (e) {
                    console.warn(`Server ${i + 1} gagal:`, e);
                    // Lanjut ke iterasi berikutnya (Server cadangan)
                }
            }

            loader.classList.add('hidden');

            if (!success) {
                alert(`Gagal mengunduh dari semua server ${platformData.name}. Pastikan link valid atau coba lagi nanti.`);
            }
        }

        // --- RENDER HASIL (ADAPTIVE) ---
        function renderResult(data) {
            const container = document.getElementById('resultContent');
            const section = document.getElementById('resultSection');
            
            // Normalisasi data (karena struktur API berbeda-beda)
            let d = data.result || data.data || data; 

            // Cek apakah array (biasanya search result)
            if (Array.isArray(d)) d = d[0]; // Ambil yang pertama jika array

            let thumb = d.thumbnail || d.cover || d.image || 'https://via.placeholder.com/300?text=No+Image';
            let title = d.title || d.caption || d.name || d.filename || 'Hasil Download';
            
            let buttonsHtml = '';

            // Helper untuk tombol
            const btn = (url, label, icon = 'fa-download') => `
                <a href="${url}" target="_blank" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white py-3 px-4 rounded-xl flex items-center justify-between group transition mb-2">
                    <span class="flex items-center gap-2 text-sm font-semibold"><i class="fa-solid ${icon} text-blue-400"></i> ${label}</span>
                    <i class="fa-solid fa-chevron-right text-xs text-slate-500 group-hover:text-white"></i>
                </a>`;

            // Logika Deteksi URL Download
            // 1. YouTube/Audio Style
            if (d.download && d.download.url) buttonsHtml += btn(d.download.url, 'Download MP3', 'fa-music');
            
            // 2. Multi format (Video/Audio)
            if (d.url) buttonsHtml += btn(d.url, 'Download File Utama');
            if (d.video) buttonsHtml += btn(d.video, 'Download Video', 'fa-video');
            if (d.audio) buttonsHtml += btn(d.audio, 'Download Audio', 'fa-music');
            if (d.hd) buttonsHtml += btn(d.hd, 'Download HD Quality', 'fa-video');
            if (d.sd) buttonsHtml += btn(d.sd, 'Download SD Quality', 'fa-video');

            // 3. Simple URL String (Jaga-jaga API return string langsung)
            if (typeof d === 'string' && d.startsWith('http')) buttonsHtml += btn(d, 'Download File');

            // 4. Kasus Array di dalam object (misal Instagram slide)
            if (Array.isArray(d)) {
                 d.forEach((item, idx) => {
                     if(typeof item === 'string') buttonsHtml += btn(item, `Media ${idx+1}`, 'fa-image');
                 });
            }

            container.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 shrink-0">
                        <img src="${thumb}" class="w-full rounded-xl shadow-lg border border-slate-600/50" alt="Thumb">
                    </div>
                    <div class="w-full">
                        <h3 class="text-lg font-bold text-white mb-4 line-clamp-2">${title}</h3>
                        <div class="space-y-2 max-h-60 overflow-y-auto pr-1 custom-scroll">
                            ${buttonsHtml || '<p class="text-red-400 text-sm">Link download tidak ditemukan dalam respon API.</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            section.classList.remove('hidden');
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- PWA & UI UTILS ---
        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        let deferredPrompt;
        window.addEventListener('load', () => {
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
            setTimeout(() => document.getElementById('pwaPopup').classList.remove('translate-y-full'), 3000);
        });
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        async function installPwa() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                closePwa();
            } else {
                alert("Gunakan menu browser 'Add to Home Screen' untuk menginstall.");
            }
        }
        function closePwa() { document.getElementById('pwaPopup').classList.add('translate-y-full'); }
    </script>
</body>
</html>
