<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Downloader ‚Ä¢</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Download video TikTok, YouTube, Spotify, IG dan lainnya dalam satu aplikasi.">
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/7269/7269995.png" type="image/png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #0f172a; color: white; }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gradient-text {
            background: linear-gradient(to right, #60a5fa, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Animasi Loading */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .animate-ring { animation: pulse-ring 2s infinite; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col relative overflow-x-hidden selection:bg-blue-500 selection:text-white">

    <nav class="glass fixed top-0 w-full z-50 px-6 py-4 flex justify-between items-center shadow-lg transition-all duration-300">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-bolt text-white"></i>
            </div>
            <h1 class="text-xl font-bold tracking-wide">Multi<span class="text-blue-400">Loader</span></h1>
        </div>
        <button onclick="toggleModal('aboutModal')" class="text-sm font-semibold text-slate-300 hover:text-white transition bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700">
            <i class="fa-solid fa-circle-info mr-1"></i> Info
        </button>
    </nav>

    <main class="container mx-auto mt-28 px-4 pb-24 max-w-3xl">
        
        <div class="text-center mb-8 animate-fade-in">
            <h2 class="text-3xl md:text-5xl font-bold mb-3 text-white">
                Download <span class="gradient-text">Everything.</span>
            </h2>
            <p class="text-slate-400 text-sm md:text-base">Paste link TikTok, YouTube, Spotify, IG, dll. Biar sistem yang bekerja.</p>
        </div>

        <div class="glass rounded-2xl p-2 md:p-3 mb-8 shadow-2xl shadow-blue-900/10 relative z-20 transition-all duration-300 hover:shadow-blue-900/20 border border-slate-700">
            <div class="flex flex-col md:flex-row gap-2">
                <div class="relative w-full group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i id="inputIcon" class="fa-solid fa-link text-slate-500 transition-colors duration-300"></i>
                    </div>
                    <input type="text" id="urlInput" 
                        class="w-full bg-slate-800/50 border border-slate-600 rounded-xl pl-12 pr-4 py-4 focus:outline-none focus:border-blue-500 focus:bg-slate-800 transition text-white placeholder-slate-500" 
                        placeholder="Tempel link di sini..."
                        autocomplete="off"
                        oninput="checkAutoDetect(this.value)">
                </div>
                <button onclick="processInput()" id="actionBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-xl font-bold transition flex items-center justify-center gap-2 whitespace-nowrap shadow-lg shadow-blue-600/30 active:scale-95">
                    <i class="fa-solid fa-cloud-arrow-down"></i> <span id="btnText">Download</span>
                </button>
            </div>
            
            <div id="statusBadge" class="hidden mt-3 px-2 flex items-center justify-between text-xs font-mono">
                <div class="flex items-center gap-2 text-blue-400">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                    </span>
                    <span id="statusText">Mendeteksi link...</span>
                </div>
                <button onclick="resetMode()" class="text-slate-500 hover:text-white underline">Reset</button>
            </div>
        </div>

        <div class="mb-4 flex justify-between items-end px-1">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Pilih Manual / Cari Lagu</h3>
        </div>

        <div class="grid grid-cols-4 md:grid-cols-6 gap-3 mb-10">
            <div id="serviceGrid" class="contents"></div>
        </div>

        <div id="resultSection" class="hidden glass rounded-2xl overflow-hidden border-t-2 border-blue-500/50 transition-all duration-500">
            <div class="bg-slate-800/50 px-6 py-3 border-b border-slate-700 flex justify-between items-center">
                <span class="text-sm font-semibold text-blue-400"><i class="fa-solid fa-check-circle mr-2"></i>Berhasil</span>
                <button onclick="closeResult()" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="resultContent" class="p-6"></div>
        </div>
        
        <div id="loader" class="hidden py-12 text-center">
            <div class="relative w-16 h-16 mx-auto mb-4">
                <div class="absolute inset-0 rounded-full border-4 border-slate-700"></div>
                <div class="absolute inset-0 rounded-full border-4 border-t-blue-500 animate-spin"></div>
            </div>
            <p class="text-slate-300 font-medium animate-pulse" id="loadingText">Menghubungkan ke Server...</p>
            <p class="text-xs text-slate-500 mt-2">Sedang mencoba server terbaik...</p>
        </div>

    </main>

    <div id="aboutModal" class="fixed inset-0 z-[100] hidden bg-black/90 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="glass bg-slate-900 p-8 rounded-3xl max-w-sm w-full text-center relative shadow-2xl border border-slate-700 transform scale-100 transition-transform">
            <button onclick="toggleModal('aboutModal')" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800 rounded-full p-2 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            
            <div class="w-24 h-24 bg-gradient-to-br from-blue-600 to-purple-700 rounded-2xl rotate-6 mx-auto mb-6 flex items-center justify-center text-4xl text-white font-bold shadow-lg shadow-blue-600/20 border border-white/10">
                IB
            </div>
            
            <h3 class="text-2xl font-bold text-white mb-1">Multi Downloader</h3>
            <p class="text-blue-400 text-xs font-mono uppercase tracking-widest mb-6">All-in-One Tools</p>
            
            <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700">
                <p class="text-xs text-slate-500 uppercase tracking-widest mb-2">Developed by</p>
                <p class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 tracking-wider">
                    „ÄêÔªø ùïÄùï•ùï§ùïìùïíùïï „Äë
                </p>
            </div>
            <div class="mt-6 text-xs text-slate-500">
                &copy; 2025 Itsbad Store Project.
            </div>
        </div>
    </div>

    <div id="pwaPopup" class="fixed bottom-0 left-0 right-0 glass border-t border-slate-700 p-4 transform translate-y-full transition-transform duration-500 z-50 flex items-center justify-between md:rounded-t-2xl md:max-w-md md:mx-auto md:bottom-4 md:rounded-b-2xl shadow-2xl">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2.5 rounded-xl text-white shadow-lg shadow-blue-600/40">
                <i class="fa-solid fa-download"></i>
            </div>
            <div>
                <h4 class="font-bold text-sm text-white">Install App</h4>
                <p class="text-[10px] text-slate-300">Akses cepat tanpa browser</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="closePwa()" class="text-slate-400 px-3 hover:text-white text-xs font-medium">Nanti</button>
            <button onclick="installPwa()" class="bg-white text-slate-900 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-50 transition shadow-lg">Install</button>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURASI API & SERVER CADANGAN ---
        const apiBase = "https://api.ootaizumi.web.id/downloader/";

        // Format: Key = ID, apis = Array [Utama, Cadangan 1, Cadangan 2...]
        const platforms = {
            tiktok: {
                name: "TikTok",
                icon: "fa-brands fa-tiktok",
                match: ["tiktok.com"],
                apis: [
                    { end: "tiktok", param: "url" },
                    { end: "ssstiktok", param: "url" },
                    { end: "snaptik", param: "url" }
                ]
            },
            youtube: {
                name: "YouTube",
                icon: "fa-brands fa-youtube",
                match: ["youtube.com", "youtu.be"],
                apis: [
                    { end: "youtube", param: "url", extra: "&format=mp4" },
                    { end: "youtubev2", param: "url" },
                    { end: "youtube-play", param: "query" } // Fallback search
                ]
            },
            spotify: {
                name: "Spotify",
                icon: "fa-brands fa-spotify",
                match: ["spotify.com"],
                apis: [
                    { end: "spotify-v2", param: "url" },
                    { end: "spotify", param: "url" }
                ]
            },
            instagram: {
                name: "Instagram",
                icon: "fa-brands fa-instagram",
                match: ["instagram.com"],
                apis: [ { end: "instagram", param: "url" } ]
            },
            facebook: {
                name: "Facebook",
                icon: "fa-brands fa-facebook",
                match: ["facebook.com", "fb.watch"],
                apis: [ { end: "facebook", param: "url" } ]
            },
            twitter: {
                name: "Twitter/X",
                icon: "fa-brands fa-x-twitter",
                match: ["twitter.com", "x.com"],
                apis: [ { end: "twitter", param: "url" } ]
            },
            soundcloud: {
                name: "SoundCloud",
                icon: "fa-brands fa-soundcloud",
                match: ["soundcloud.com"],
                apis: [ { end: "soundcloud", param: "url" } ]
            },
            scribd: {
                name: "Scribd",
                icon: "fa-solid fa-book-open",
                match: ["scribd.com"],
                apis: [ { end: "scribd", param: "url" } ]
            },
            sfile: {
                name: "Sfile.mobi",
                icon: "fa-solid fa-folder-open",
                match: ["sfile.mobi"],
                apis: [ { end: "sfile", param: "url" } ]
            },
            gdrive: {
                name: "Google Drive",
                icon: "fa-brands fa-google-drive",
                match: ["drive.google.com"],
                apis: [ { end: "gdrive", param: "url" } ]
            },
            mediafire: {
                name: "Mediafire",
                icon: "fa-solid fa-fire",
                match: ["mediafire.com"],
                apis: [ { end: "mediafire", param: "url" } ]
            },
            rednote: {
                name: "RedNote",
                icon: "fa-solid fa-book-journal-whills",
                match: ["xiaohongshu.com"],
                apis: [ { end: "rednote", param: "url" } ]
            },
            // MANUAL SEARCH MODES
            ytsearch: {
                name: "Cari Lagu YT",
                icon: "fa-solid fa-magnifying-glass",
                isSearch: true,
                apis: [ { end: "youtube-play", param: "query" } ]
            },
            spotsearch: {
                name: "Cari Lagu Spotify",
                icon: "fa-brands fa-spotify",
                isSearch: true,
                apis: [ { end: "spotifyplay", param: "query" } ]
            }
        };

        let currentMode = 'auto'; 

        // --- 2. GENERATE UI GRID ---
        const grid = document.getElementById('serviceGrid');
        Object.keys(platforms).forEach(key => {
            const p = platforms[key];
            const div = document.createElement('div');
            div.className = "glass p-3 rounded-xl flex flex-col items-center gap-2 cursor-pointer hover:bg-slate-700/50 transition active:scale-95 border border-transparent hover:border-slate-600";
            div.onclick = () => setManualMode(key);
            div.innerHTML = `
                <i class="${p.icon} text-2xl text-slate-300"></i>
                <span class="text-[10px] font-semibold text-slate-400 text-center leading-tight">${p.name}</span>
            `;
            grid.appendChild(div);
        });

        // --- 3. AUTO DETECT SYSTEM ---
        function checkAutoDetect(val) {
            const icon = document.getElementById('inputIcon');
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');

            if (!val) {
                resetMode();
                return;
            }

            // Loop untuk cek kecocokan domain
            let detected = null;
            for (const [key, data] of Object.entries(platforms)) {
                if (data.match && data.match.some(domain => val.includes(domain))) {
                    detected = key;
                    break;
                }
            }

            if (detected) {
                currentMode = detected;
                const p = platforms[detected];
                icon.className = `${p.icon} text-blue-400`;
                statusBadge.classList.remove('hidden');
                statusText.innerText = `Terdeteksi: ${p.name}`;
                statusText.className = "text-blue-400 text-sm font-semibold";
                document.getElementById('actionBtn').classList.add('animate-ring');
            } else {
                // Jika input ada tapi tidak cocok domain apapun
                if(currentMode === 'auto') {
                    icon.className = "fa-solid fa-link text-slate-500";
                    statusBadge.classList.add('hidden');
                    document.getElementById('actionBtn').classList.remove('animate-ring');
                }
            }
        }

        function setManualMode(key) {
            currentMode = key;
            const p = platforms[key];
            const input = document.getElementById('urlInput');
            
            document.getElementById('inputIcon').className = `${p.icon} text-blue-400`;
            document.getElementById('statusBadge').classList.remove('hidden');
            document.getElementById('statusText').innerText = `Mode Manual: ${p.name}`;
            
            if(p.isSearch) {
                input.placeholder = `Ketik judul lagu untuk ${p.name}...`;
                document.getElementById('btnText').innerText = "Cari";
            } else {
                input.placeholder = `Tempel link ${p.name}...`;
                document.getElementById('btnText').innerText = "Download";
            }
            input.value = '';
            input.focus();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetMode() {
            currentMode = 'auto';
            document.getElementById('inputIcon').className = "fa-solid fa-link text-slate-500";
            document.getElementById('statusBadge').classList.add('hidden');
            document.getElementById('urlInput').placeholder = "Tempel link di sini...";
            document.getElementById('btnText').innerText = "Download";
            document.getElementById('actionBtn').classList.remove('animate-ring');
        }

        // --- 4. PROSES DATA (LOGIKA UTAMA) ---
        async function processInput() {
            const input = document.getElementById('urlInput').value.trim();
            if (!input) return alert("Harap masukkan link atau kata kunci!");

            if (currentMode === 'auto') {
                if (!input.startsWith('http')) return alert("Gunakan fitur 'Cari Lagu' di bawah untuk pencarian judul.");
                alert("Platform tidak dikenali atau link tidak support. Coba pilih manual.");
                return;
            }

            const platformData = platforms[currentMode];
            const loader = document.getElementById('loader');
            const resultSection = document.getElementById('resultSection');
            const loadingText = document.getElementById('loadingText');

            resultSection.classList.add('hidden');
            loader.classList.remove('hidden');
            document.getElementById('resultContent').innerHTML = ''; // Clear old

            // Loop API (Fallback System)
            let success = false;
            for (let i = 0; i < platformData.apis.length; i++) {
                const api = platformData.apis[i];
                loadingText.innerText = `Menghubungkan Server ${i + 1} (${platformData.name})...`;

                try {
                    let fetchUrl = `${apiBase}${api.end}?${api.param}=${encodeURIComponent(input)}`;
                    if (api.extra) fetchUrl += api.extra;

                    const response = await fetch(fetchUrl);
                    const json = await response.json();

                    // Validasi hasil
                    if (json && (json.url || json.result || json.data || Array.isArray(json.result))) {
                        renderResult(json);
                        success = true;
                        break; // BERHASIL -> STOP LOOP
                    }
                } catch (e) {
                    console.warn(`Server ${i + 1} Error:`, e);
                }
            }

            loader.classList.add('hidden');
            if (!success) {
                alert(`Gagal mengambil data dari ${platformData.name}. Kemungkinan server sedang sibuk atau link private.`);
            }
        }

        function renderResult(data) {
            const container = document.getElementById('resultContent');
            const section = document.getElementById('resultSection');
            
            // Normalisasi JSON
            let d = data.result || data.data || data; 
            if (Array.isArray(d)) d = d[0];

            let thumb = d.thumbnail || d.cover || d.image || 'https://via.placeholder.com/300?text=No+Image';
            let title = d.title || d.caption || d.name || d.filename || 'Hasil Download';
            
            // Helper Button Builder
            const btn = (url, label, icon = 'fa-download', color = 'bg-slate-700') => `
                <a href="${url}" target="_blank" class="w-full ${color} hover:bg-slate-600 border border-slate-600 text-white py-3 px-4 rounded-xl flex items-center justify-between group transition mb-2 shadow-lg">
                    <span class="flex items-center gap-3 text-sm font-semibold"><i class="fa-solid ${icon} text-blue-400"></i> ${label}</span>
                    <i class="fa-solid fa-cloud-arrow-down text-slate-400 group-hover:text-white"></i>
                </a>`;

            let buttonsHtml = '';

            // Logic tombol berdasarkan data yang ada
            if (d.download && d.download.url) buttonsHtml += btn(d.download.url, 'Download Audio', 'fa-music', 'bg-slate-800');
            
            if (d.url) buttonsHtml += btn(d.url, 'Download File Utama');
            if (d.video) buttonsHtml += btn(d.video, 'Download Video MP4', 'fa-video');
            if (d.audio) buttonsHtml += btn(d.audio, 'Download Audio MP3', 'fa-music');
            if (d.hd) buttonsHtml += btn(d.hd, 'Kualitas HD', 'fa-video');
            if (d.sd) buttonsHtml += btn(d.sd, 'Kualitas SD', 'fa-video');
            
            // Fallback string url
            if (typeof d === 'string' && d.startsWith('http')) buttonsHtml += btn(d, 'Download File');

            // Array Content (Slide IG / Search Results)
            if (Array.isArray(data.result) && data.result.length > 1) {
                 data.result.forEach((item, idx) => {
                     if(typeof item === 'string') buttonsHtml += btn(item, `Media Slide ${idx+1}`, 'fa-image');
                     else if(item.url) buttonsHtml += btn(item.url, `Download ${idx+1}`, 'fa-file');
                 });
            }

            container.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 shrink-0">
                        <img src="${thumb}" class="w-full rounded-xl shadow-lg border border-slate-600/50 aspect-video object-cover" alt="Preview">
                    </div>
                    <div class="w-full">
                        <h3 class="text-lg font-bold text-white mb-4 line-clamp-2">${title}</h3>
                        <div class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scroll">
                            ${buttonsHtml || '<p class="text-red-400 text-sm">Link download tidak ditemukan.</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            section.classList.remove('hidden');
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function closeResult() {
            document.getElementById('resultSection').classList.add('hidden');
        }

        // --- PWA LOGIC ---
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        let deferredPrompt;
        window.addEventListener('load', () => {
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
            setTimeout(() => document.getElementById('pwaPopup').classList.remove('translate-y-full'), 3000);
        });
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        async function installPwa() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                closePwa();
            } else {
                alert("Pada browser ini, gunakan menu 'Add to Home Screen' atau 'Install App' secara manual.");
            }
        }
        function closePwa() { document.getElementById('pwaPopup').classList.add('translate-y-full'); }
    </script>
</body>
</html>
